# Use the latest 2.1 version of CircleCI pipeline process engine. See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1
# Use a package of configuration called an orb.
orbs:
    docker: circleci/docker@1.5.0

# Orchestrate or schedule a set of jobs
jobs:
  build:
    environment:
      DOCKERFILE: vaapi
    machine: true
    steps:
      - run:
          name: Custom enviroment variables
          command: |
            echo 'export FROM_IMAGE=jrottenberg/ffmpeg:snapshot-${DOCKERFILE}' >> ${BASH_ENV}
            if [[ "${CIRCLE_BRANCH}" == "master" ]]; then
              echo 'export THIS_LABEL=${DOCKERFILE}' >> ${BASH_ENV}
            else 
              echo 'export THIS_LABEL=${DOCKERFILE}-${CIRCLE_BRANCH}' >> ${BASH_ENV}
            fi
            echo 'export THIS_FULL_IMAGE=${THIS_REGISTRY}/${THIS_IMAGE}:${THIS_LABEL}' >> ${BASH_ENV}
            echo 'export CACHE_FROM_IMAGE=${THIS_REGISTRY}/${THIS_REPO}/${THIS_IMAGE}:${DOCKERFILE}' >> ${BASH_ENV}
      - run:
          name: Trust private docker registries
          command: |
            sudo mkdir -p "/etc/docker/certs.d/${THIS_REGISTRY}"
            openssl s_client -showcerts -connect ${THIS_REGISTRY} < /dev/null 2> /dev/null | openssl x509 -outform PEM | sudo tee "/etc/docker/certs.d/${THIS_REGISTRY}/ca.crt"
            echo ${THIS_REGISTRY_PASSWORD} | docker login --username ${THIS_REGISTRY_USERNAME} --password-stdin ${THIS_REGISTRY}
      - checkout
      - docker/check:
          docker-username: $THIS_REGISTRY_USERNAME
          docker-password: $THIS_REGISTRY_PASSWORD
          registry: $THIS_REGISTRY
      - run:
          name: Build docker image
          command: |
            echo "FROM_IMAGE=${FROM_IMAGE}"
            echo "THIS_LABEL=${THIS_LABEL}"
            echo "DOCKERFILE=${DOCKERFILE}"
            echo "CIRCLE_BRANCH=${CIRCLE_BRANCH}"
            if [[ ! ${CIRCLE_BRANCH} ~= (master|v.*) ]]; then
              docker pull ${CACHE_FROM_IMAGE} || true
            else
              export CACHE_FROM_ARGS="--no-cache"
            fi
            cd travis
            ./build.sh
